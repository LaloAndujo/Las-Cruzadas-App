<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear Evento ‚Äî Las Cruzadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root { --gold:#d4af37; --bg:#0a0a0a; --panel:#121212; --muted:#9fa3a8; --text:#fff; }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:880px; margin:32px auto; padding:0 16px; }
    .nav{ display:flex; gap:14px; align-items:center; margin-bottom:22px; flex-wrap:wrap; }
    .nav a{ color:var(--gold); text-decoration:none; font-weight:700; }
    h1{ font-weight:900; color:var(--gold); margin:10px 0 6px; }
    .card{ background:var(--panel); border:1px solid #2a2a2a; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .row-1{ display:grid; grid-template-columns:1fr; gap:14px; }
    label{ font-size:14px; color:#ddd; font-weight:600; margin-bottom:6px; display:block; }
    input, textarea{ width:100%; border-radius:10px; border:1px solid #2a2a2a; background:#0e0e0e; color:#fff; padding:12px; font-size:16px; outline:none; }
    textarea{ min-height:120px; resize:vertical; }
    .hint{ color:var(--muted); font-size:12px; margin-top:4px; }
    .actions{ display:flex; gap:12px; margin-top:16px; }
    .btn{ border:none; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer; }
    .btn-primary{ background:var(--gold); color:#0a0a0a; }
    .btn-secondary{ background:transparent; color:var(--gold); border:1px solid var(--gold); }
    .status{ margin-top:12px; min-height:24px; font-size:14px; }
    .ok{ color:#9be38b; } .err{ color:#ff8a80; }
    .brand{ font-weight:900; color:var(--gold); margin-right:auto; }
    @media (max-width:780px){ .row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">‚öîÔ∏è Las Cruzadas</div>
      <a href="/dashboard">üè† Dashboard</a>
      <a href="/feed.html">üì∞ Feed</a>
      <a href="/eventos">üìÖ Eventos</a>
      <a href="#" id="qrLink">üì≤ Mi QR</a>
      <a href="/logout">üö™ Cerrar sesi√≥n</a>
    </div>

    <h1>Crear un nuevo evento</h1>
    <p class="hint">Completa los datos y guarda. Solo admins deber√≠an tener acceso a este formulario.</p>

    <form id="formEvento" class="card" novalidate>
      <div class="row">
        <div>
          <label for="nombre">Nombre del evento</label>
          <input id="nombre" name="nombre" placeholder="Noche de fogata y torneo" required maxlength="140" />
        </div>
        <div>
          <label for="ubicacion">Ubicaci√≥n</label>
          <input id="ubicacion" name="ubicacion" placeholder="Playas de Tijuana" required maxlength="200" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="fecha">Fecha y hora</label>
          <input id="fecha" name="fecha" type="datetime-local" required />
          <div class="hint">Debe ser futura. Se definir√° en tu zona horaria.</div>
        </div>
        <div>
          <label for="tz">Zona horaria (informativa)</label>
          <input id="tz" disabled />
        </div>
      </div>

      <div class="row-1">
        <div>
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" name="descripcion" placeholder="Detalles, qu√© llevar, punto de reuni√≥n, etc." required maxlength="2000"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" type="button" id="cancelar">Cancelar</button>
        <button class="btn btn-primary" type="submit" id="submitBtn">Crear evento</button>
      </div>
      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    // Utilidades
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const btn = $('#submitBtn');

    // Mostrar TZ y poner m√≠nimo "ahora" en el datetime-local
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
    $('#tz').value = tz;

    function toLocalInputValue(d) {
      const pad = n => String(n).padStart(2,'0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    const now = new Date();
    $('#fecha').min = toLocalInputValue(new Date(now.getTime() + 5*60*1000)); // +5min
    $('#fecha').value = toLocalInputValue(new Date(now.getTime() + 60*60*1000)); // por defecto +1h

    // QR
    $('#qrLink').addEventListener('click', (e) => {
      e.preventDefault();
      const nick = sessionStorage.getItem('nickname') || 'Cruzado';
      location.href = `/qr.html?user=${encodeURIComponent(nick)}`;
    });

    // Cancelar
    $('#cancelar').onclick = () => history.length > 1 ? history.back() : location.href='/eventos';

    // Validaci√≥n b√°sica
    function validate(formData){
      const required = ['nombre','descripcion','ubicacion','fecha'];
      for (const key of required) {
        if (!formData.get(key) || !String(formData.get(key)).trim()) return key;
      }
      const when = new Date(formData.get('fecha'));
      if (isNaN(when.getTime()) || when < new Date()) return 'fecha';
      return null;
    }

    // Submit
    $('#formEvento').addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      const data = new FormData(e.target);
      const invalid = validate(data);
      if (invalid) {
        statusEl.className = 'status err';
        statusEl.textContent = 'Revisa el campo: ' + invalid;
        return;
      }

      // UX: deshabilita bot√≥n
      btn.disabled = true; btn.textContent = 'Creando...';

      try {
        const payload = Object.fromEntries(data.entries());
        // Normalizamos fecha a ISO (el input devuelve hora local)
        payload.fecha = new Date(payload.fecha).toISOString();

        const res = await fetch('/api/crear-evento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'Error al crear evento');
        }

        statusEl.className = 'status ok';
        statusEl.textContent = '‚úÖ Evento creado';
        setTimeout(() => location.href = '/eventos', 600);
      } catch (err) {
        statusEl.className = 'status err';
        statusEl.textContent = '‚ùå ' + (err.message || 'Error desconocido');
      } finally {
        btn.disabled = false; btn.textContent = 'Crear evento';
      }
    });
  </script>
</body>
</html>
