<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evento ‚Äî Las Cruzadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root { --gold:#d4af37; --gold-soft:#b8962e; --bg:#0a0a0a; --panel:#121212; --muted:#9fa3a8; --text:#fff; }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:1000px; margin:28px auto; padding:0 16px; }
    .nav{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
    .brand{ font-weight:900; color:var(--gold); margin-right:auto; font-size:18px; }
    .nav a{ color:var(--gold); text-decoration:none; font-weight:700; }
    h1{ margin:8px 0 14px; color:var(--gold); font-weight:900; }

    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:var(--panel); border:1px solid #2a2a2a; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .title{ margin:0 0 6px; font-size:22px; font-weight:900; color:#fff; }
    .muted{ color:var(--muted); font-size:14px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#1a1a1a; border:1px solid #333; color:#ddd; font-weight:700; font-size:12px; }
    .pill.gold{ background:var(--gold); color:#0a0a0a; border-color:var(--gold); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; }
    .btn-primary{ background:var(--gold); color:#0a0a0a; }
    .btn-outline{ background:transparent; color:var(--gold); border:1px solid var(--gold); }
    input, select{ width:100%; border-radius:10px; border:1px solid #2a2a2a; background:#0e0e0e; color:#fff; padding:10px 12px; font-size:15px; outline:none; }
    label{ font-size:14px; color:#ddd; font-weight:600; margin:6px 0 4px; display:block; }

    /* Lista de rides */
    .ride{ border:1px solid #2a2a2a; border-radius:12px; padding:12px; margin-top:10px; }
    .ride .hdr{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .ride .meta{ color:var(--muted); font-size:13px; }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid #333; background:#151515; font-size:12px; color:#ddd; }
    .badge.ok{ background:var(--gold); color:#0a0a0a; border-color:var(--gold); }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal .box{ width:min(520px,92vw); background:#111; border:1px solid #2a2a2a; border-radius:14px; padding:16px; }
    .modal h3{ margin:0 0 6px; color:var(--gold); }
    .close{ appearance:none; border:none; background:transparent; color:#bbb; font-size:22px; cursor:pointer; margin-left:auto; }

    /* Mapa de asientos (din√°mico) */
    .seat-map{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; justify-items:center; margin-top:12px; }
    .seat{ width:56px; height:56px; border-radius:12px; border:1px solid #333; background:#151515; color:#ddd; font-weight:800; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .seat.taken{ background:#3a3a3a; color:#888; cursor:not-allowed; }
    .seat.selected{ outline:3px solid var(--gold); }
    .legend{ display:flex; gap:10px; align-items:center; margin-top:10px; color:#bbb; font-size:12px; }
    .legend .sw{ width:16px; height:16px; border-radius:4px; border:1px solid #333; background:#151515; }
    .legend .sw.t{ background:#3a3a3a; }
    .legend .sw.s{ outline:3px solid var(--gold); }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111; border:1px solid #333; color:var(--gold); padding:10px 14px; border-radius:10px; font-weight:700; display:none; z-index:1200; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav card">
      <div class="brand">‚öîÔ∏è Las Cruzadas</div>
      <a href="/dashboard">üè† Dashboard</a>
      <a href="/feed.html">üì∞ Feed</a>
      <a href="/eventos">üìÖ Eventos</a>
      <a href="#" id="qrLink">üì≤ Mi QR</a>
      <a href="/logout">üö™ Cerrar sesi√≥n</a>
    </div>

    <h1>Detalle del evento</h1>

    <div class="grid">
      <!-- Detalle -->
      <div class="card" id="detalle">
        <h2 class="title" id="ev-title">Cargando‚Ä¶</h2>
        <div class="muted" id="ev-sub">‚Äî</div>
        <p id="ev-desc" class="muted" style="margin-top:8px;">‚Äî</p>
        <div class="row" style="gap:8px; margin-top:10px;">
          <span class="pill" id="ev-cond">Conductores: 0</span>
          <span class="pill" id="ev-pass">Pasajeros: 0</span>
        </div>
      </div>

      <!-- Participaci√≥n -->
      <div class="card">
        <h3 style="margin:0 0 8px;">¬øC√≥mo quieres asistir?</h3>
        <div class="row">
          <button class="btn btn-outline" id="btnPasajero">üßç Pasajero</button>
          <button class="btn btn-primary" id="btnConductor">üöò Conductor</button>
        </div>

        <!-- Conductor -->
        <div id="formConductor" style="display:none; margin-top:12px;">
          <label for="espacios">Asientos disponibles</label>
          <input id="espacios" type="number" min="1" max="8" placeholder="3" />
          <label for="puntoSalida">Punto de salida</label>
          <input id="puntoSalida" placeholder="Parque X / Casa Y" />
          <label for="horaSalida">Hora de salida</label>
          <input id="horaSalida" placeholder="18:30" />
          <div class="row" style="margin-top:10px;">
            <button class="btn btn-primary" id="saveRide">Registrar ride</button>
          </div>
          <div class="muted" style="margin-top:6px;">Se crear√°n asientos numerados 1..N.</div>
        </div>

        <!-- Pasajero -->
        <div id="formPasajero" style="display:none; margin-top:12px;">
          <div class="row">
            <button class="btn btn-outline" id="joinQueue">Unirme a la fila</button>
            <button class="btn btn-outline" id="refresh">Actualizar rides</button>
          </div>
          <div id="rides" style="margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal asientos -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <h3>Seleccionar asiento</h3>
        <button class="close" id="closeModal">‚úï</button>
      </div>
      <div id="modalInfo" class="muted">‚Äî</div>
      <div class="seat-map" id="seatMap"></div>
      <div class="legend"><span class="sw"></span> Libre <span class="sw t"></span> Ocupado <span class="sw s"></span> Seleccionado</div>
      <div class="row" style="margin-top:12px;">
        <button class="btn btn-outline" id="cancelSeat">Cancelar</button>
        <button class="btn btn-primary" id="confirmSeat">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Hecho</div>

  <script>
    // Utils
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const eventoId = params.get('id');
    const nickname = sessionStorage.getItem('nickname') || 'Cruzado';

    let ridesCache = [];
    let selectedRideId = null;
    let selectedSeat = null;

    $('#qrLink').addEventListener('click', e => {
      e.preventDefault();
      location.href = `/qr.html?user=${encodeURIComponent(nickname)}`;
    });

    // UI helpers
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
    function show(el, v){ el.style.display = v ? '' : 'none'; }

    // Cargar detalle
    async function loadEvent(){
      if(!eventoId){ $('#detalle').innerHTML = '<p>Evento no especificado.</p>'; return; }
      const res = await fetch(`/api/events/${eventoId}`);
      if(!res.ok){ $('#detalle').innerHTML = '<p>Error al cargar el evento.</p>'; return; }
      const ev = await res.json();
      $('#ev-title').textContent = ev.nombre;
      $('#ev-sub').textContent = new Date(ev.fecha).toLocaleString('es-MX',{ weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' }) + (ev.ubicacion?` ¬∑ ${ev.ubicacion}`:'');
      $('#ev-desc').textContent = ev.descripcion || '';
      $('#ev-cond').textContent = `Conductores: ${(ev.conductores||[]).length}`;
      $('#ev-pass').textContent = `Pasajeros: ${(ev.pasajeros||[]).length}`;
      // habilita panel de participaci√≥n
      show($('#btnPasajero').closest('.card'), true);
    }

    // Modo
    $('#btnConductor').onclick = ()=>{ show($('#formConductor'), true); show($('#formPasajero'), false); };
    $('#btnPasajero').onclick = ()=>{ show($('#formConductor'), false); show($('#formPasajero'), true); loadRides(); };

    // Conductor ‚Üí crear ride
    $('#saveRide').onclick = async ()=>{
      const espacios = parseInt($('#espacios').value,10);
      const puntoSalida = $('#puntoSalida').value.trim();
      const horarioSalida = $('#horaSalida').value.trim();
      if(!espacios || espacios<1){ toast('Indica asientos'); return; }
      const res = await fetch('/api/rides', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ eventoId, espaciosDisponibles: espacios, puntoSalida, horarioSalida })
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){ toast('Ride creado'); $('#espacios').value=''; $('#puntoSalida').value=''; $('#horaSalida').value=''; loadRides(); }
      else { toast(j.error || j.mensaje || 'Error creando ride'); }
    };

    // Pasajero ‚Üí fila
    $('#joinQueue').onclick = async ()=>{
      const res = await fetch('/api/fila-pasajeros', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ eventoId })
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok) toast('Agregado a la fila'); else toast(j.error || 'Ya est√°s en la fila');
    };

    // Cargar rides
    $('#refresh').onclick = ()=> loadRides();
    async function loadRides(){
      const box = $('#rides');
      box.innerHTML = '<div class="muted">Cargando rides‚Ä¶</div>';
      const res = await fetch(`/api/rides-disponibles/${eventoId}`);
      const arr = await res.json().catch(()=>[]);
      ridesCache = Array.isArray(arr)?arr:[];
      if(!ridesCache.length){ box.innerHTML = '<div class="muted">Sin rides por ahora.</div>'; return; }
      box.innerHTML = '';
      for(const r of ridesCache){
        const libres = (r.asientos||[]).filter(a=>!a.ocupadoPor).length;
        const cap = (r.asientos||[]).length;
        const div = document.createElement('div');
        div.className = 'ride';
        div.innerHTML = `
          <div class="hdr">
            <div><strong>${r.conductorId?.nickname || 'Conductor'}</strong></div>
            <span class="badge ${libres>0?'ok':''}">${libres}/${cap} libres</span>
          </div>
          <div class="meta">Salida: ${r.horarioSalida || '-'} ¬∑ Punto: ${r.puntoSalida || '-'}</div>
          <div class="row" style="margin-top:8px;">
            <button class="btn btn-primary" ${libres? '' : 'disabled'} data-open="${r._id}">Ver asientos</button>
          </div>
        `;
        box.appendChild(div);
      }
      // Listeners
      box.querySelectorAll('[data-open]').forEach(b=>{
        b.addEventListener('click', ()=> openSeatModal(b.getAttribute('data-open')));
      });
    }

    // Modal asientos (din√°mico)
    const modal = $('#modal'), seatMap = $('#seatMap'), modalInfo = $('#modalInfo');
    $('#closeModal').onclick = ()=> closeSeatModal();
    $('#cancelSeat').onclick = ()=> { selectedSeat=null; highlightSeat(); closeSeatModal(); };
    $('#confirmSeat').onclick = confirmSeat;

    function openSeatModal(rideId){
      selectedRideId = rideId; selectedSeat=null; highlightSeat();
      const ride = ridesCache.find(r=>r._id===rideId);
      if(!ride){ toast('Ride no encontrado'); return; }
      modalInfo.textContent = `Conductor: ${ride.conductorId?.nickname || '-'} ¬∑ ${ride.horarioSalida || '-'} ¬∑ ${ride.puntoSalida || '-'}`;

      // Render din√°mico: grid 3 cols (copiloto = asiento 1 si existe)
      seatMap.innerHTML = '';
      const seats = (ride.asientos||[]).slice().sort((a,b)=>a.lugar-b.lugar);
      seats.forEach(s=>{
        const btn = document.createElement('button');
        btn.className = 'seat' + (s.ocupadoPor ? ' taken' : '');
        btn.textContent = s.lugar;
        btn.disabled = !!s.ocupadoPor;
        btn.onclick = ()=>{ if(btn.disabled) return; selectedSeat = s.lugar; highlightSeat(); };
        seatMap.appendChild(btn);
      });

      modal.style.display='flex';
    }
    function closeSeatModal(){ modal.style.display='none'; }
    function highlightSeat(){
      seatMap.querySelectorAll('.seat').forEach(el=>{
        const n = parseInt(el.textContent,10);
        el.classList.toggle('selected', selectedSeat===n);
      });
    }

    async function confirmSeat(){
      if(!selectedRideId || !selectedSeat){ toast('Elige un asiento'); return; }
      const res = await fetch('/api/seleccionar-asiento', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ rideId: selectedRideId, lugar: selectedSeat })
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok){ toast('Asiento reservado'); closeSeatModal(); loadRides(); }
      else { toast(j.error || j.mensaje || 'No se pudo reservar'); }
    }

    // Go!
    (async function init(){
      if(!eventoId){ $('.wrap').innerHTML='<p>Evento no especificado.</p>'; return; }
      await loadEvent();
    })();
  </script>
</body>
</html>
