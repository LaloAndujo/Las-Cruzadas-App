<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>⚔️ Las Cruzadas — Beta VIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/style.css" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="nav card">
      <div class="brand">⚔️ Las Cruzadas</div>
      <button class="navbtn" data-goto="#dashboard">🏠 Dashboard</button>
      <button class="navbtn" data-goto="#feed">📰 Feed</button>
      <button class="navbtn" data-goto="#eventos">📅 Eventos</button>
      <button class="navbtn" data-goto="#crear">➕ Crear evento</button>
      <button class="navbtn" data-goto="#raites">🚗 Raites</button>
      <a class="navbtn danger" id="logoutBtn">🚪 Salir</a>
    </div>

    <!-- AUTH -->
    <div class="card" id="view-auth">
      <div class="split">
        <div class="pane">
          <h2 class="title">Iniciar sesión</h2>
          <form id="loginForm" class="form">
            <label>Correo / Usuario / Apodo</label>
            <input name="emailOrUser" placeholder="tu@correo.com o @apodo" required />
            <label>Contraseña</label>
            <div class="row">
              <input type="password" name="password" id="loginPass" placeholder="********" required />
              <button type="button" class="toggle" data-toggle="#loginPass">👁️</button>
            </div>
            <button class="btn btn-primary">Entrar</button>
            <div class="msg" id="loginMsg"></div>
          </form>
        </div>
        <div class="pane">
          <h2 class="title">Crear cuenta</h2>
          <form id="regForm" class="form">
            <label>Correo</label>
            <input type="email" name="email" placeholder="tú@correo.com" required />
            <label>Apodo</label>
            <input name="nickname" placeholder="Tu apodo" required maxlength="30" />
            <label>Contraseña</label>
            <div class="row">
              <input type="password" name="password" id="regPass" minlength="6" placeholder="Mín. 6 caracteres" required />
              <button type="button" class="toggle" data-toggle="#regPass">👁️</button>
            </div>
            <button class="btn btn-primary">Crear cuenta</button>
            <div class="msg" id="regMsg"></div>
          </form>
        </div>
      </div>
      <p class="muted" style="text-align:center;margin-top:10px;">Beta VIP — tema dorado, animaciones y toasts 😎</p>
    </div>

    <!-- DASHBOARD -->
    <div class="card" id="view-dashboard" style="display:none;">
      <div class="grid2">
        <div>
          <h1 class="hero" id="nickTitle">Bienvenido, cruzado</h1>
          <div class="meta">
            <span class="pill">Puntos: <span id="points">0</span></span>
            <span class="muted">Gana puntos al publicar, etiquetar, dar like y crear eventos/raites.</span>
          </div>
          <div class="controls mt8">
            <button class="btn btn-outline" id="copyProfile">📲 Copiar enlace de perfil</button>
            <button class="btn btn-outline" id="showQR">🧾 Ver mi QR</button>
          </div>
          <div class="qrbox" id="qrBox" style="display:none;">
            <img id="qrImg" alt="QR" />
          </div>
        </div>
        <div>
          <div class="panel glow">
            <h3 style="margin:0 0 6px;">Publicar estado</h3>
            <form id="postForm">
              <textarea id="status" name="status" placeholder="¿Qué estás sintiendo hoy, cruzado? Usa @apodo para etiquetar." maxlength="1000" required></textarea>
              <input type="hidden" name="tags" id="tags" />
              <div class="tags" id="tagsPreview"></div>
              <div class="row space">
                <button class="btn" type="button" id="clearBtn">Limpiar</button>
                <button class="btn btn-primary" type="submit" id="postBtn">Publicar</button>
                <span class="muted" id="charCount">0/1000</span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- FEED -->
    <div class="card" id="view-feed" style="display:none;">
      <h2 class="title">Feed</h2>
      <div id="feedList" class="feed"></div>
    </div>

    <!-- EVENTOS LIST -->
    <div class="card" id="view-eventos" style="display:none;">
      <h2 class="title">Próximos eventos</h2>
      <div id="evList" class="cards"></div>
      <div id="evEmpty" class="muted" style="display:none;">Aún no hay eventos.</div>
    </div>

    <!-- CREAR EVENTO -->
    <div class="card" id="view-crear" style="display:none;">
      <h2 class="title">Crear evento</h2>
      <form id="evForm" class="form">
        <label>Nombre</label><input name="nombre" required maxlength="80" />
        <label>Descripción</label><textarea name="descripcion" required maxlength="500"></textarea>
        <label>Fecha y hora</label><input type="datetime-local" name="fecha" required />
        <label>Ubicación</label><input name="ubicacion" required maxlength="120" />
        <button class="btn btn-primary mt8">Crear</button>
        <div class="msg" id="evMsg"></div>
      </form>
    </div>

    <!-- DETALLE EVENTO -->
    <div class="card" id="view-ev" style="display:none;">
      <div id="evBox">Cargando…</div>
      <div class="row mt8">
        <button class="btn" id="joinPas">Asistir como pasajero</button>
      </div>
      <div class="row wrap mt8">
        <input class="sm" id="auto" placeholder="Auto (opcional)" />
        <input class="sm" id="lugares" type="number" min="1" value="1" />
        <input class="sm" id="hora" placeholder="Hora salida (opcional)" />
        <input class="sm" id="punto" placeholder="Punto de reunión (opcional)" />
        <button class="btn" id="joinDrv">Ofrecer raite</button>
      </div>
      <div class="row mt8">
        <button class="btn danger" id="delEv">Borrar evento (creador)</button>
      </div>
      <div class="muted mt6" id="evMsg2"></div>
    </div>

    <!-- RAITES -->
    <div class="card" id="view-raites" style="display:none;">
      <h2 class="title">Raites</h2>
      <div class="grid2">
        <div class="panel">
          <h3 style="margin:0 0 6px;">Ofrecer raite</h3>
          <form id="rideForm" class="form">
            <label>Destino</label><input name="destino" required />
            <label>Punto de reunión</label><input name="puntoReunion" />
            <label>Fecha y hora de salida</label><input type="datetime-local" name="horaSalida" required />
            <label>Lugares totales</label><input type="number" name="lugaresTotales" min="1" value="3" required />
            <label>Auto (opcional)</label><input name="auto" />
            <label>Notas (opcional)</label><textarea name="notas"></textarea>
            <button class="btn btn-primary mt8">Publicar raite</button>
            <div class="msg" id="rideMsg"></div>
          </form>
        </div>
        <div>
          <div id="rideList" class="cards"></div>
          <div id="rideEmpty" class="muted" style="display:none;">Aún no hay raites.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Hecho</div>

<script>
const $ = s => document.querySelector(s);

// NAV
document.querySelectorAll('.navbtn[data-goto]').forEach(b=> b.onclick = ()=> location.hash = b.getAttribute('data-goto'));
$('#logoutBtn').onclick = async ()=>{
  await fetch('/logout'); toast('Sesión cerrada'); location.hash = '#'; currentUser=null; show('view-auth');
};

function show(id){
  ['view-auth','view-dashboard','view-feed','view-eventos','view-crear','view-ev','view-raites']
    .forEach(v=> $('#'+v).style.display='none');
  $('#'+id).style.display = 'block';
}
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }

// SESSION / USER
let currentUser = null;
async function loadUser(){
  try{
    const res = await fetch('/api/user');
    if (res.status === 401) { currentUser = null; show('view-auth'); return; }
    const u = await res.json();
    currentUser = u;
    $('#nickTitle').textContent = `Bienvenido, ${u.nickname || 'Cruzado'}`;
    $('#points').textContent = typeof u.points === 'number' ? u.points : 0;
    show('view-dashboard');
  }catch{ currentUser = null; show('view-auth'); }
}

// AUTH forms
document.querySelectorAll('.toggle').forEach(btn=>{
  btn.onclick = ()=>{
    const sel = btn.getAttribute('data-toggle'); const i = document.querySelector(sel);
    if (!i) return; i.type = i.type === 'password' ? 'text' : 'password';
  };
});

$('#loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = Object.fromEntries(new FormData(e.target));
  const r = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fd) });
  const d = await r.json().catch(()=>({}));
  if (r.ok){ toast('¡Bienvenido!'); await loadUser(); location.hash='#dashboard'; }
  else $('#loginMsg').textContent = d.error || 'Error';
});
$('#regForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = Object.fromEntries(new FormData(e.target));
  const r = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fd) });
  const d = await r.json().catch(()=>({}));
  if (r.ok){ toast('Cuenta creada'); await loadUser(); location.hash='#dashboard'; }
  else $('#regMsg').textContent = d.error || 'Error';
});

// QR + perfil
$('#showQR').onclick = async ()=>{
  const r = await fetch('/api/user/qr'); if (!r.ok) return toast('Error QR');
  const { qrImage } = await r.json();
  $('#qrImg').src = qrImage; $('#qrBox').style.display = 'block';
};
$('#copyProfile').onclick = async ()=>{
  if (!currentUser?.nickname) return;
  const url = `${location.origin}/perfil/${encodeURIComponent(currentUser.nickname)}`;
  try { await navigator.clipboard.writeText(url); toast('Enlace copiado'); } catch { toast('Copia manual: '+url); }
};

// POST: autosize + tags + publish
const ta = $('#status'), counter = $('#charCount'), tagsHidden = $('#tags'), tagsPreview = $('#tagsPreview');
function autosize(){ ta.style.height='auto'; ta.style.height=Math.min(220, ta.scrollHeight)+'px'; }
function parseTags(text){ return [...new Set((String(text).match(/@\w+/g)||[]).map(t=>t.slice(1)))]; }
function renderTags(tags){ tagsPreview.innerHTML=''; tags.forEach(t=>{ const el=document.createElement('span'); el.className='tag'; el.textContent='@'+t; tagsPreview.appendChild(el); }); }
function onInput(){ autosize(); counter.textContent = `${ta.value.length}/1000`; const tags=parseTags(ta.value); tagsHidden.value=JSON.stringify(tags); renderTags(tags); }
ta.addEventListener('input', onInput); onInput();
$('#clearBtn').onclick = ()=>{ ta.value=''; onInput(); ta.focus(); };
$('#postForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); $('#postBtn').disabled=true; $('#postBtn').textContent='Publicando…';
  const payload = { status: ta.value, tags: tagsHidden.value };
  const res = await fetch('/post-status', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  $('#postBtn').disabled=false; $('#postBtn').textContent='Publicar';
  if (res.ok){ ta.value=''; onInput(); toast('Publicado'); await loadFeed(); } else { toast('Error al publicar'); }
});

// FEED
async function loadFeed(){
  const r = await fetch('/api/feed'); if (r.status===401){ show('view-auth'); return; }
  const data = await r.json();
  const list = $('#feedList'); list.innerHTML='';
  data.forEach(p=>{
    const card = document.createElement('div'); card.className='card post';
    const isMine = currentUser && currentUser.nickname === p.user;
    card.innerHTML = `
      <div class="post-head">
        <div class="avatar">${(p.user[0]||'C').toUpperCase()}</div>
        <div>
          <div class="nick">@${p.user}</div>
          <div class="muted tiny">Puntos del autor: ${p.points||0}</div>
        </div>
        <div class="grow"></div>
        ${isMine ? `<button class="icon danger" data-del="${p._id}" title="Borrar">🗑️</button>` : ''}
      </div>
      <div class="post-body">${(p.content||'').replace(/</g,'&lt;')}</div>
      <div class="post-actions">
        <button class="btn small" data-like="${p._id}">❤️ ${p.likes||0}</button>
      </div>
    `;
    list.appendChild(card);
  });
  list.querySelectorAll('[data-like]').forEach(b=>{
    b.onclick = async ()=>{ const id=b.getAttribute('data-like'); const r=await fetch('/api/posts/'+id+'/like',{method:'POST'}); if(r.ok){ await loadFeed(); } };
  });
  list.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async ()=>{ const id=b.getAttribute('data-del'); if(!confirm('¿Borrar post?')) return; const r=await fetch('/api/post/'+id,{method:'DELETE'}); if(r.ok){ await loadFeed(); } };
  });
}

// EVENTOS
async function loadEvents(){
  const res = await fetch('/api/events'); if (res.status===401){ show('view-auth'); return; }
  const data = await res.json();
  const list = $('#evList'), empty = $('#evEmpty'); list.innerHTML='';
  if (!Array.isArray(data) || data.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  data.forEach(ev=>{
    const d = new Date(ev.fecha);
    const el = document.createElement('div'); el.className='panel ev';
    el.innerHTML = `
      <div class="ev-title">${ev.nombre}</div>
      <div class="muted tiny">${isNaN(d)? '' : d.toLocaleString()} — ${ev.ubicacion||''}</div>
      <div class="muted">${(ev.descripcion||'').slice(0,180)}</div>
      <div class="row mt6">
        <button class="btn btn-outline small" data-open="${ev._id}">Ver detalle</button>
      </div>
    `;
    list.appendChild(el);
  });
  list.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> { location.hash = '#ev:'+b.getAttribute('data-open'); });
}

$('#evForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); $('#evMsg').textContent='';
  const fd = Object.fromEntries(new FormData(e.target));
  const res = await fetch('/api/crear-evento', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fd) });
  if (res.ok){ toast('Evento creado'); e.target.reset(); location.hash='#eventos'; await loadEvents(); }
  else { $('#evMsg').textContent = await res.text(); }
});

async function loadEvent(id){
  const res = await fetch('/api/events/'+encodeURIComponent(id));
  if (!res.ok){ $('#evBox').innerHTML='No encontrado'; return; }
  const ev = await res.json(); const d = new Date(ev.fecha);
  $('#evBox').innerHTML = `
    <h2 class="title">${ev.nombre}</h2>
    <div class="muted tiny">${isNaN(d)? '' : d.toLocaleString()} — ${ev.ubicacion||''}</div>
    <p style="margin-top:8px;">${ev.descripcion||''}</p>
    <div class="muted tiny">Creador: ${ev.creador||''}</div>
  `;
  $('#joinPas').onclick = async ()=>{
    const r = await fetch('/api/evento/asistencia', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventoId:id, modo:'pasajero' }) });
    $('#evMsg2').textContent = r.ok ? 'Asistencia registrada' : 'Error';
  };
  $('#joinDrv').onclick = async ()=>{
    const payload = { eventoId:id, modo:'conductor', auto:$('#auto').value, lugaresDisponibles: $('#lugares').value, horaSalida:$('#hora').value, puntoReunion:$('#punto').value };
    const r = await fetch('/api/evento/asistencia', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    $('#evMsg2').textContent = r.ok ? 'Conductor registrado' : 'Error';
  };
  $('#delEv').onclick = async ()=>{
    if (!confirm('¿Borrar evento?')) return;
    const r = await fetch('/api/event/'+encodeURIComponent(id), { method:'DELETE' });
    if (r.ok){ toast('Evento borrado'); location.hash = '#eventos'; } else { $('#evMsg2').textContent = 'No se pudo borrar (¿eres el creador?)'; }
  };
}

// RAITES
async function loadRides(){
  const r = await fetch('/api/rides'); if (r.status===401){ show('view-auth'); return; }
  const rides = await r.json();
  const list = $('#rideList'), empty=$('#rideEmpty'); list.innerHTML='';
  if (!rides.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  rides.forEach(ride=>{
    const d = new Date(ride.horaSalida);
    const mine = (currentUser?.nickname === ride.conductorNick);
    const joined = (ride.pasajeros||[]).includes(currentUser?.nickname||'');
    const card = document.createElement('div'); card.className='panel ride';
    card.innerHTML = `
      <div class="ev-title">A ${ride.destino}</div>
      <div class="muted tiny">${isNaN(d)? '' : d.toLocaleString()} — Punto: ${ride.puntoReunion||'N/A'} — Auto: ${ride.auto||'N/A'}</div>
      <div class="muted tiny">Conductor: @${ride.conductorNick}</div>
      <div class="seats">
        ${Array.from({length: ride.lugaresTotales}).map((_,i)=>{
          const taken = i < (ride.lugaresTotales - ride.lugaresDisponibles);
          return `<span class="seat ${taken?'taken':''}"></span>`;
        }).join('')}
      </div>
      <div class="row mt6">
        ${!mine && !joined ? `<button class="btn small" data-join="${ride._id}">Subirme</button>` : ''}
        ${!mine && joined ? `<button class="btn small" data-leave="${ride._id}">Bajarme</button>` : ''}
        ${mine ? `<button class="btn danger small" data-del-ride="${ride._id}">Borrar</button>` : ''}
      </div>
      ${ride.notas ? `<div class="muted tiny mt6">${ride.notas}</div>` : ''}
    `;
    list.appendChild(card);
  });
  list.querySelectorAll('[data-join]').forEach(b=> b.onclick = async ()=>{
    const id=b.getAttribute('data-join'); const r=await fetch('/api/rides/'+id+'/join',{method:'POST'}); if(r.ok){ toast('Te subiste'); loadRides(); } else toast('No se pudo');
  });
  list.querySelectorAll('[data-leave]').forEach(b=> b.onclick = async ()=>{
    const id=b.getAttribute('data-leave'); const r=await fetch('/api/rides/'+id+'/leave',{method:'POST'}); if(r.ok){ toast('Te bajaste'); loadRides(); } else toast('No se pudo');
  });
  list.querySelectorAll('[data-del-ride]').forEach(b=> b.onclick = async ()=>{
    const id=b.getAttribute('data-del-ride'); if(!confirm('¿Borrar raite?')) return;
    const r=await fetch('/api/rides/'+id,{method:'DELETE'}); if(r.ok){ toast('Raite borrado'); loadRides(); } else toast('No se pudo');
  });
}

$('#rideForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); $('#rideMsg').textContent='';
  const fd = Object.fromEntries(new FormData(e.target));
  const r = await fetch('/api/rides',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fd) });
  if (r.ok){ toast('Raite publicado'); e.target.reset(); loadRides(); } else { const d=await r.json().catch(()=>({})); $('#rideMsg').textContent=d.error||'Error'; }
});

// ROUTER
async function router(){
  const h = location.hash || '#dashboard';
  if (!currentUser) { await loadUser(); if (!currentUser) { show('view-auth'); return; } }
  if (h.startsWith('#ev:')){ show('view-ev'); await loadEvent(h.slice(4)); return; }
  switch(h){
    case '#dashboard': show('view-dashboard'); break;
    case '#feed': show('view-feed'); await loadFeed(); break;
    case '#eventos': show('view-eventos'); await loadEvents(); break;
    case '#crear': show('view-crear'); break;
    case '#raites': show('view-raites'); await loadRides(); break;
    default: show('view-dashboard');
  }
}
window.addEventListener('hashchange', router);

// INIT
(async ()=>{ await loadUser(); await router(); })();
</script>
</body>
</html>
