<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äî Las Cruzadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root { --gold:#d4af37; --gold-soft:#b8962e; --bg:#0a0a0a; --panel:#121212; --muted:#9fa3a8; --text:#fff; }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:980px; margin:28px auto; padding:0 16px; }
    .nav{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
    .brand{ font-weight:900; color:var(--gold); margin-right:auto; font-size:18px; }
    .nav a{ color:var(--gold); text-decoration:none; font-weight:700; }
    h1{ margin:8px 0 2px; color:var(--gold); font-weight:900; }
    .card{ background:var(--panel); border:1px solid #2a2a2a; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.35); margin-bottom:16px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--gold); color:#0a0a0a; font-weight:800; }
    .muted{ color:var(--muted); font-size:14px; }
    textarea{ width:100%; min-height:120px; resize:vertical; border-radius:12px; border:1px solid #2a2a2a; background:#0e0e0e; color:#fff; padding:12px; font-size:16px; outline:none; }
    .controls{ display:flex; align-items:center; gap:10px; margin-top:10px; }
    .btn{ border:none; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer; }
    .btn-primary{ background:var(--gold); color:#0a0a0a; }
    .btn-outline{ background:transparent; color:var(--gold); border:1px solid var(--gold); }
    .meta{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tag{ border:1px solid #333; color:#ddd; padding:4px 8px; border-radius:999px; font-size:12px; }
    .counter{ margin-left:auto; color:var(--muted); font-size:12px; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111; border:1px solid #333; color:var(--gold); padding:10px 14px; border-radius:10px; font-weight:700; display:none; }
    @media (max-width:780px){ .row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav card">
      <div class="brand">‚öîÔ∏è Las Cruzadas</div>
      <a href="/dashboard">üè† Dashboard</a>
      <a href="/feed.html">üì∞ Feed</a>
      <a href="/eventos">üìÖ Eventos</a>
      <a href="#" id="qrLink">üì≤ Mi QR</a>
      <a href="/logout">üö™ Cerrar sesi√≥n</a>
    </div>

    <div class="card">
      <h1 id="nickname">Bienvenido, cruzado</h1>
      <div class="meta">
        <span class="pill">Puntos: <span id="points">0</span></span>
        <span class="muted">Publica, responde y da ‚Äúme gusta‚Äù para ganar puntos.</span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Publicar estado</h3>
      <form id="postForm" action="/post-status" method="POST">
        <textarea id="status" name="status" placeholder="¬øQu√© est√°s sintiendo hoy, cruzado?" maxlength="1000" required></textarea>
        <input type="hidden" name="tags" id="tags" />
        <div class="tags" id="tagsPreview"></div>
        <div class="controls">
          <button class="btn btn-outline" type="button" id="clearBtn">Limpiar</button>
          <button class="btn btn-primary" type="submit" id="postBtn">Publicar</button>
          <span class="counter" id="charCount">0/1000</span>
        </div>
      </form>
      <div class="muted" style="margin-top:6px;">Tip: etiqueta a otros con <strong>@apodo</strong>.</div>
    </div>

    <div class="row">
      <div class="card">
        <h3 style="margin:0 0 8px;">Accesos r√°pidos</h3>
        <div class="controls" style="gap:8px; flex-wrap:wrap;">
          <a class="btn btn-outline" href="/eventos">Ver eventos</a>
          <a class="btn btn-outline" href="/crear-evento.html">Crear evento</a>
          <button class="btn btn-outline" id="copyQR">Copiar enlace QR</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px;">Recordatorio</h3>
        <div class="muted">Puedes publicar hasta 3 veces al d√≠a con puntos extra.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Hecho</div>

  <script>
    const $ = s => document.querySelector(s);
    const nickname = sessionStorage.getItem('nickname') || 'Cruzado';
    $('#nickname').textContent = `Bienvenido, ${nickname}`;

    // QR link
    $('#qrLink').addEventListener('click', e => {
      e.preventDefault();
      location.href = `/qr.html?user=${encodeURIComponent(nickname)}`;
    });

    // Copiar enlace QR
    $('#copyQR').addEventListener('click', async () => {
      const url = `${location.origin}/qr.html?user=${encodeURIComponent(nickname)}`;
      try { await navigator.clipboard.writeText(url); toast('Link QR copiado'); } catch { toast('Copia manual: ' + url); }
    });

    // Cargar puntos reales
    async function cargarPuntos() {
      try {
        const res = await fetch('/api/user');
        if (!res.ok) return;
        const data = await res.json();
        if (typeof data.points === 'number') $('#points').textContent = data.points;
        if (data.nickname) sessionStorage.setItem('nickname', data.nickname);
      } catch (e) { /* noop */ }
    }
    cargarPuntos();

    // Autosize + contador + preview de @tags
    const ta = $('#status');
    const counter = $('#charCount');
    const tagsHidden = $('#tags');
    const tagsPreview = $('#tagsPreview');

    function autosize() {
      ta.style.height = 'auto';
      ta.style.height = Math.min(220, ta.scrollHeight) + 'px';
    }
    function parseTags(text) {
      return [...new Set((text.match(/@\w+/g) || []).map(t => t.slice(1)))];
    }
    function renderTags(tags) {
      tagsPreview.innerHTML = '';
      tags.forEach(t => {
        const el = document.createElement('span');
        el.className = 'tag';
        el.textContent = '@' + t;
        tagsPreview.appendChild(el);
      });
    }
    function onInput() {
      autosize();
      counter.textContent = `${ta.value.length}/1000`;
      const tags = parseTags(ta.value);
      tagsHidden.value = JSON.stringify(tags);
      renderTags(tags);
    }
    ta.addEventListener('input', onInput);
    onInput();

    // Limpiar
    $('#clearBtn').addEventListener('click', () => {
      ta.value = '';
      onInput();
      ta.focus();
    });

    // Submit UX
    const form = $('#postForm');
    const btn = $('#postBtn');
    form.addEventListener('submit', () => {
      btn.disabled = true; btn.textContent = 'Publicando...';
      // dejamos que haga POST normal (compat con tu server)
      setTimeout(() => { btn.disabled = false; btn.textContent = 'Publicar'; }, 3000);
    });

    // Toast helper
    function toast(msg){
      const t = $('#toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', 1500);
    }
  </script>
</body>
</html>
